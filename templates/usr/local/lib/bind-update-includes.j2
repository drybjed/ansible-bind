#!/bin/bash

# {{ ansible_managed }}

# Update 'all.conf' files in the /etc/bind/namd.conf.d/ directories.


set -eu -o pipefail

generate_includes () {

    local tmpconf="all.conf.tmp"
    local allconf="all.conf"

    local directory="${1}"
    local prefix="${2:-}"

    if [ -d "${directory}" ] ; then
        cd "${directory}"
        touch "${tmpconf}"
        echo -e "// Include file autogenerated by bind-update-includes\n" >> "${tmpconf}"

        if [ -n "${prefix}" ] ; then

            for filename in ${prefix}.* ; do
                if [ -r "${filename}" ] ; then
                    echo "include \"$(pwd)/${filename}\";" >> "${tmpconf}"
                fi
            done

        else

            for filename in * ; do
                if [ "${filename}" != "${allconf}" -a -d "${filename}" -a -r "${filename}/${allconf}" ] ; then
                    echo "include \"$(pwd)/${filename}/${allconf}\";" >> "${tmpconf}"
                fi
            done

        fi

        mv "${tmpconf}" "${allconf}"

        cd - > /dev/null
    fi
}

for zone_set in /etc/bind/named.conf.d/zones/* /etc/bind/named.conf.d/views/zones.* ; do
    generate_includes "${zone_set}" "zone"
done
generate_includes "/etc/bind/named.conf.d/views" "view"
generate_includes "/etc/bind/named.conf.d/zones"
